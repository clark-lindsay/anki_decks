<h3 id="with/1-beware" class="section-heading">
    Beware!
</h3>
<p>Keep in mind that, one of potential drawback of <code class="inline">with</code> is that all
failure clauses are {{c1::flattened into a single <code class="inline">else</code> block}}. For example,
take this code that checks if a given path points to an Elixir file
and that it exists before creating a backup copy:</p>
<pre><code class="makeup elixir" translate="no"><span class="k">with</span><span class="w"> </span><span class="s">".ex"</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Path</span><span class="o">.</span><span class="n">extname</span><span class="p" data-group-id="2367760229-1">(</span><span class="n">path</span><span class="p" data-group-id="2367760229-1">)</span><span class="p">,</span><span class="w">
     </span><span class="no">true</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">File</span><span class="o">.</span><span class="n">exists?</span><span class="p" data-group-id="2367760229-2">(</span><span class="n">path</span><span class="p" data-group-id="2367760229-2">)</span><span class="w"> </span><span class="k" data-group-id="2367760229-3">do</span><span class="w">
  </span><span class="n">backup_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">".backup"</span><span class="w">
  </span><span class="nc">File</span><span class="o">.</span><span class="n">cp!</span><span class="p" data-group-id="2367760229-4">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">backup_path</span><span class="p" data-group-id="2367760229-4">)</span><span class="w">
  </span><span class="p" data-group-id="2367760229-5">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">backup_path</span><span class="p" data-group-id="2367760229-5">}</span><span class="w">
</span><span class="k" data-group-id="2367760229-3">else</span><span class="w">
  </span><span class="n">binary</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">is_binary</span><span class="p" data-group-id="2367760229-6">(</span><span class="n">binary</span><span class="p" data-group-id="2367760229-6">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2367760229-7">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:invalid_extension</span><span class="p" data-group-id="2367760229-7">}</span><span class="w">

  </span><span class="no">false</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2367760229-8">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:missing_file</span><span class="p" data-group-id="2367760229-8">}</span><span class="w">
</span><span class="k" data-group-id="2367760229-3">end</span></code></pre>
<p>Note how we are having to reconstruct the result types of <code class="inline">Path.extname/1</code> and <code class="inline">File.exists?/1</code> to build error messages. In this case, it is better to change the with clauses to already return the desired format, like this:</p>
<pre><code class="makeup elixir" translate="no"><span class="k">with</span><span class="w"> </span><span class="ss">:ok</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">validate_extension</span><span class="p" data-group-id="5510271592-1">(</span><span class="n">path</span><span class="p" data-group-id="5510271592-1">)</span><span class="p">,</span><span class="w">
     </span><span class="ss">:ok</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">validate_exists</span><span class="p" data-group-id="5510271592-2">(</span><span class="n">path</span><span class="p" data-group-id="5510271592-2">)</span><span class="w"> </span><span class="k" data-group-id="5510271592-3">do</span><span class="w">
  </span><span class="n">backup_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">".backup"</span><span class="w">
  </span><span class="nc">File</span><span class="o">.</span><span class="n">cp!</span><span class="p" data-group-id="5510271592-4">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">backup_path</span><span class="p" data-group-id="5510271592-4">)</span><span class="w">
  </span><span class="p" data-group-id="5510271592-5">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">backup_path</span><span class="p" data-group-id="5510271592-5">}</span><span class="w">
</span><span class="k" data-group-id="5510271592-3">end</span><span class="w">

</span><span class="kd">defp</span><span class="w"> </span><span class="nf">validate_extname</span><span class="p" data-group-id="5510271592-6">(</span><span class="n">path</span><span class="p" data-group-id="5510271592-6">)</span><span class="w"> </span><span class="k" data-group-id="5510271592-7">do</span><span class="w">
  </span>{{c2::<span class="k">if</span><span class="w"> </span><span class="nc">Path</span><span class="o">.</span><span class="n">extname</span><span class="p" data-group-id="5510271592-8">(</span><span class="n">path</span><span class="p" data-group-id="5510271592-8">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">".ex"</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5510271592-9">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:invalid_extension</span><span class="p" data-group-id="5510271592-9">}</span>}}<span class="w">
</span><span class="k" data-group-id="5510271592-7">end</span><span class="w">

</span><span class="kd">defp</span><span class="w"> </span><span class="nf">validate_exists</span><span class="p" data-group-id="5510271592-10">(</span><span class="n">path</span><span class="p" data-group-id="5510271592-10">)</span><span class="w"> </span><span class="k" data-group-id="5510271592-11">do</span><span class="w">
  </span>{{c2::<span class="k">if</span><span class="w"> </span><span class="nc">File</span><span class="o">.</span><span class="n">exists?</span><span class="p" data-group-id="5510271592-12">(</span><span class="n">path</span><span class="p" data-group-id="5510271592-12">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5510271592-13">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:missing_file</span><span class="p" data-group-id="5510271592-13">}</span>}}<span class="w">
</span><span class="k" data-group-id="5510271592-11">end</span></code></pre>

